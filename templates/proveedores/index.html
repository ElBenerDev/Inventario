<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proveedores - Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    {% include 'nav.html' %}

    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Gestión de Proveedores</h1>
            <button onclick="openNewProviderModal()" 
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Nuevo Proveedor
            </button>
        </div>

        <!-- Filtros -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="search" 
                           class="w-full rounded border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                           placeholder="Nombre, RUC o código...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                    <select id="categoria" class="w-full rounded border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="">Todas</option>
                        {% for categoria in categorias_proveedores %}
                        <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                    <select id="estado" class="w-full rounded border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                    <select id="ciudad" class="w-full rounded border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="">Todas</option>
                        {% for proveedor in proveedores | unique(attribute='ciudad') %}
                        <option value="{{ proveedor.ciudad }}">{{ proveedor.ciudad }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabla de Proveedores -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                            onclick="sortTable('codigo')">
                            Código <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                            onclick="sortTable('nombre')">
                            Nombre <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ciudad</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Compra</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="proveedoresTableBody">
                    {% for proveedor in proveedores %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ proveedor.codigo }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ proveedor.nombre }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ proveedor.categoria }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ proveedor.ciudad }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex flex-col">
                                <span>{{ proveedor.contacto_nombre }}</span>
                                <span class="text-xs text-gray-400">{{ proveedor.contacto_email }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                       {% if proveedor.estado == 'activo' %}bg-green-100 text-green-800
                                       {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ proveedor.estado }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ proveedor.ultima_compra.strftime('%Y-%m-%d') if proveedor.ultima_compra else 'Sin compras' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <a href="{{ url_for('gestionar_proveedor', id=proveedor.id) }}" 
                                   class="text-indigo-600 hover:text-indigo-900" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button onclick="editarProveedor({{ proveedor.id }})"
                                        class="text-blue-600 hover:text-blue-900" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="eliminarProveedor({{ proveedor.id }})"
                                        class="text-red-600 hover:text-red-900" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

        <!-- Modal Nuevo/Editar Proveedor -->
        <div id="proveedorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-bold" id="modalTitle">Nuevo Proveedor</h3>
                    <button onclick="closeProveedorModal()" class="text-black close-modal">&times;</button>
                </div>
                <form id="proveedorForm" onsubmit="guardarProveedor(event)" class="space-y-6">
                    <input type="hidden" id="proveedor_id" name="id">
                    
                    <!-- Información General -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Código</label>
                            <input type="text" id="codigo" name="codigo" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">RUC</label>
                            <input type="text" id="ruc" name="ruc" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombre" name="nombre" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="categoria_form" name="categoria" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                {% for categoria in categorias_proveedores %}
                                <option value="{{ categoria }}">{{ categoria }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Estado</label>
                            <select id="estado_form" name="estado" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Términos de Pago</label>
                            <select id="terminos_pago" name="terminos_pago" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                {% for termino in terminos_pago %}
                                <option value="{{ termino }}">{{ termino }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
    
                    <!-- Información de Contacto -->
                    <div class="border-t pt-4">
                        <h4 class="text-lg font-medium mb-4">Información de Contacto</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ciudad</label>
                                <input type="text" id="ciudad_form" name="ciudad" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Dirección</label>
                                <input type="text" id="direccion" name="direccion" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="telefono" name="telefono" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" name="email" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
    
                    <!-- Información de Contacto Principal -->
                    <div class="border-t pt-4">
                        <h4 class="text-lg font-medium mb-4">Contacto Principal</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="contacto_nombre" name="contacto_nombre" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="contacto_telefono" name="contacto_telefono" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="contacto_email" name="contacto_email" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeProveedorModal()"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    
        <script>
            let sortDirection = 1;
            let currentSort = '';
    
            function openNewProviderModal() {
                document.getElementById('modalTitle').textContent = 'Nuevo Proveedor';
                document.getElementById('proveedorForm').reset();
                document.getElementById('proveedor_id').value = '';
                document.getElementById('proveedorModal').classList.remove('hidden');
            }
    
            function closeProveedorModal() {
                document.getElementById('proveedorModal').classList.add('hidden');
            }
    
            function editarProveedor(id) {
                fetch(`/proveedor/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('modalTitle').textContent = 'Editar Proveedor';
                        document.getElementById('proveedor_id').value = data.id;
                        
                        // Llenar el formulario con los datos del proveedor
                        Object.keys(data).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data[key];
                            }
                        });
    
                        document.getElementById('proveedorModal').classList.remove('hidden');
                    })
                    .catch(error => console.error('Error:', error));
            }
    
            function eliminarProveedor(id) {
                if (confirm('¿Está seguro de que desea eliminar este proveedor?')) {
                    fetch(`/proveedor/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error al eliminar el proveedor');
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            }
    
            function guardarProveedor(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);
                const id = data.id;
                
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/proveedor/${id}` : '/proveedores';
    
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error al guardar el proveedor');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
    
            // Funciones de filtrado y ordenamiento
            function sortTable(column) {
                if (currentSort === column) {
                    sortDirection *= -1;
                } else {
                    currentSort = column;
                    sortDirection = 1;
                }
    
                const tbody = document.getElementById('proveedoresTableBody');
                const rows = Array.from(tbody.getElementsByTagName('tr'));
    
                rows.sort((a, b) => {
                    const aValue = a.cells[getColumnIndex(column)].textContent;
                    const bValue = b.cells[getColumnIndex(column)].textContent;
                    return aValue.localeCompare(bValue) * sortDirection;
                });
    
                rows.forEach(row => tbody.appendChild(row));
            }
    
            function getColumnIndex(column) {
                const headers = {
                    'codigo': 0,
                    'nombre': 1,
                    'categoria': 2,
                    'ciudad': 3
                };
                return headers[column] || 0;
            }
    
            // Event Listeners para filtros
            document.getElementById('search').addEventListener('input', filtrarProveedores);
            document.getElementById('categoria').addEventListener('change', filtrarProveedores);
            document.getElementById('estado').addEventListener('change', filtrarProveedores);
            document.getElementById('ciudad').addEventListener('change', filtrarProveedores);
    
            function filtrarProveedores() {
                const search = document.getElementById('search').value.toLowerCase();
                const categoria = document.getElementById('categoria').value.toLowerCase();
                const estado = document.getElementById('estado').value.toLowerCase();
                const ciudad = document.getElementById('ciudad').value.toLowerCase();
    
                const rows = document.getElementById('proveedoresTableBody').getElementsByTagName('tr');
    
                Array.from(rows).forEach(row => {
                    const codigo = row.cells[0].textContent.toLowerCase();
                    const nombre = row.cells[1].textContent.toLowerCase();
                    const categoriaRow = row.cells[2].textContent.toLowerCase();
                    const ciudadRow = row.cells[3].textContent.toLowerCase();
                    const estadoRow = row.cells[5].textContent.toLowerCase();
    
                    const matchSearch = codigo.includes(search) || 
                                      nombre.includes(search);
                    const matchCategoria = !categoria || categoriaRow === categoria;
                    const matchEstado = !estado || estadoRow === estado;
                    const matchCiudad = !ciudad || ciudadRow === ciudad;
    
                    row.style.display = matchSearch && matchCategoria && 
                                      matchEstado && matchCiudad ? '' : 'none';
                });
            }
        </script>
    </body>
    </html>